# Alertmanager configuration for Advancia Pay
global:
  smtp_smarthost: "localhost:587"
  smtp_from: "alerts@advancia.pay"
  pagerduty_url: "https://events.pagerduty.com/v2/enqueue"

# Templates for alert messages
templates:
  - "/etc/alertmanager/templates/*.tmpl"

# Routing configuration
route:
  group_by: ["alertname", "service"]
  group_wait: 10s
  group_interval: 5m
  repeat_interval: 12h
  receiver: "default-receiver"

  routes:
    # Critical alerts go to PagerDuty immediately
    - match:
        severity: critical
      receiver: "pagerduty-critical"
      group_wait: 0s
      repeat_interval: 5m

    # SLA breaches get escalated routing
    - match:
        alertname: SLABreach
      receiver: "sla-breach-escalation"
      group_wait: 0s
      repeat_interval: 1h

    # Warning alerts go to Slack/Teams
    - match:
        severity: warning
      receiver: "slack-warnings"
      group_wait: 2m
      repeat_interval: 2h

    # Info alerts go to low-priority channels
    - match:
        severity: info
      receiver: "teams-info"
      group_wait: 5m
      repeat_interval: 24h

receivers:
  # Default receiver (fallback)
  - name: "default-receiver"
    email_configs:
      - to: "platform-team@advancia.pay"
        subject: "Advancia Pay Alert: {{ .GroupLabels.alertname }}"
        body: |
          {{ range .Alerts }}
          Alert: {{ .Annotations.summary }}
          Description: {{ .Annotations.description }}
          Service: {{ .Labels.service }}
          Severity: {{ .Labels.severity }}
          {{ end }}

  # Critical alerts - PagerDuty escalation
  - name: "pagerduty-critical"
    pagerduty_configs:
      - routing_key: "${PAGERDUTY_ROUTING_KEY}"
        description: "{{ .GroupLabels.alertname }}: {{ .CommonAnnotations.summary }}"
        severity: "{{ .CommonLabels.severity }}"
        client: "Advancia Pay Alertmanager"
        client_url: "http://alertmanager:9093"
        details:
          service: "{{ .CommonLabels.service }}"
          environment: "production"
          runbook: "{{ .CommonAnnotations.runbook_url }}"
          description: "{{ .CommonAnnotations.description }}"

    # Also send to Slack for visibility
    slack_configs:
      - api_url: "${SLACK_WEBHOOK_URL}"
        channel: "#alerts-critical"
        title: "üö® CRITICAL: {{ .CommonLabels.alertname }}"
        text: |
          *Service:* {{ .CommonLabels.service }}
          *Summary:* {{ .CommonAnnotations.summary }}
          *Description:* {{ .CommonAnnotations.description }}
          *PagerDuty:* Alert triggered
        color: "#ff0000"

  # SLA breach escalation - Multiple channels
  - name: "sla-breach-escalation"
    pagerduty_configs:
      - routing_key: "${PAGERDUTY_ROUTING_KEY}"
        description: "SLA BREACH: {{ .CommonAnnotations.summary }}"
        severity: "critical"
        client: "SLA Monitor"
        details:
          breach_type: "uptime_sla"
          threshold: "99%"
          service: "{{ .CommonLabels.service }}"

    slack_configs:
      - api_url: "${SLACK_WEBHOOK_URL}"
        channel: "#sla-alerts"
        title: "üö®üö® SLA BREACH DETECTED üö®üö®"
        text: |
          *CRITICAL:* {{ .CommonAnnotations.summary }}
          *Service:* {{ .CommonLabels.service }}
          *Impact:* Customer SLA commitment violated
          *Action Required:* Immediate investigation and remediation
        color: "#ff0000"

    webhook_configs:
      - url: "${TEAMS_WEBHOOK_URL}"
        send_resolved: true
        http_config:
          follow_redirects: true
        title: "SLA BREACH: {{ .CommonLabels.alertname }}"
        text: |
          **CRITICAL SLA BREACH DETECTED**

          Service: {{ .CommonLabels.service }}
          Summary: {{ .CommonAnnotations.summary }}
          Description: {{ .CommonAnnotations.description }}

          Immediate action required to restore service within SLA commitments.

  # Warning alerts - Slack notifications
  - name: "slack-warnings"
    slack_configs:
      - api_url: "${SLACK_WEBHOOK_URL}"
        channel: "#alerts-warnings"
        title: "‚ö†Ô∏è WARNING: {{ .CommonLabels.alertname }}"
        text: |
          *Service:* {{ .CommonLabels.service }}
          *Summary:* {{ .CommonAnnotations.summary }}
          *Description:* {{ .CommonAnnotations.description }}
          *Runbook:* {{ .CommonAnnotations.runbook_url }}
        color: "#ffaa00"

  # Info alerts - Teams notifications
  - name: "teams-info"
    webhook_configs:
      - url: "${TEAMS_WEBHOOK_URL}"
        send_resolved: true
        title: "‚ÑπÔ∏è INFO: {{ .CommonLabels.alertname }}"
        text: |
          **Information Alert**

          Service: {{ .CommonLabels.service }}
          Summary: {{ .CommonAnnotations.summary }}
          Description: {{ .CommonAnnotations.description }}

# Inhibition rules - Prevent spam during outages
inhibit_rules:
  # If service is down, inhibit high error rate alerts
  - source_match:
      alertname: ServiceDown
    target_match:
      alertname: HighErrorRate
    equal: ["service"]

  # If SLA is breached, inhibit degradation warnings
  - source_match:
      alertname: SLABreach
    target_match:
      alertname: SLADegradation
    equal: ["service"]
