# ğŸ§ª Notification Services API Testing Guide

Complete testing suite for validating the notification preferences and email services implementation.

## ğŸ“‹ Test Coverage

### âœ… **API Endpoints Tested**

- **Notification Preferences**
  - `GET /api/preferences` - Retrieve user notification preferences
  - `PUT /api/preferences` - Update notification preferences (full & partial)
  - `GET /api/preferences/channels` - Get available notification channels

- **Resend Email Service**
  - `GET /api/resend/test-connection` - Health check
  - `POST /api/resend/send` - Send direct emails
  - `POST /api/resend/template` - Send template-based emails
  - `POST /api/resend/campaign` - Send bulk campaigns (admin only)
  - `GET /api/resend/templates` - List available templates

### âœ… **Test Scenarios**

- **Authentication & Authorization**
  - Valid JWT token access
  - Unauthorized access (401)
  - Admin vs user permissions (403)
  
- **Input Validation**
  - Valid data structures
  - Invalid email formats
  - Malformed JSON payloads
  - Missing required fields
  - Invalid enum values
  
- **Business Logic**
  - Preference updates (full/partial)
  - Email template rendering
  - Campaign permissions
  - Notification logging
  
- **Performance**
  - Response time thresholds (<2000ms)
  - Concurrent request handling
  - Bulk operation efficiency
  
- **Integration**
  - End-to-end notification workflows
  - Database persistence verification
  - Cross-service communication

---

## ğŸš€ **Quick Start**

### 1. **Postman Collection**

Import the collection for manual testing:

```bash
# Location
backend/tests/postman/notification-services-api.postman_collection.json

# Environment Variables Required:
- baseUrl: http://localhost:4000
- authToken: (obtained from login)
- adminToken: (obtained from admin login)
```

### 2. **Automated Python Tests**

```bash
# Install dependencies
cd backend
pip install -r tests/requirements-test.txt

# Run all tests
python -m pytest tests/api/test_notification_services.py -v

# Run with HTML report
python -m pytest tests/api/test_notification_services.py --html=reports/test-report.html --self-contained-html

# Run specific test classes
python -m pytest tests/api/test_notification_services.py::TestNotificationPreferences -v
python -m pytest tests/api/test_notification_services.py::TestResendEmailService -v
```

### 3. **Automated Test Scripts**

```bash
# Linux/macOS
./run_api_tests.sh --all --verbose

# Windows
run_api_tests.bat

# With specific options
./run_api_tests.sh --url http://localhost:4000 --performance --integration
```

---

## ğŸ”§ **Configuration**

### **Environment Variables**

```bash
# Required for testing
API_BASE_URL=http://localhost:4000
TEST_USER_EMAIL=test@example.com
TEST_USER_PASSWORD=testPassword123
TEST_ADMIN_EMAIL=admin@example.com
TEST_ADMIN_PASSWORD=adminPassword123

# Optional
TEST_EMAIL_RECIPIENT=test@example.com
MAX_RESPONSE_TIME_MS=2000
TEST_CONCURRENCY_LEVEL=5
```

### **Test Database Setup**

```sql
-- Create test users (run in your test database)
INSERT INTO users (id, email, password, role, active) VALUES 
  ('test-user-id', 'test@example.com', 'hashed_password', 'USER', true),
  ('admin-user-id', 'admin@example.com', 'hashed_password', 'ADMIN', true);
```

---

## ğŸ“Š **Test Results & Reports**

### **HTML Reports**

- **Location**: `backend/reports/test-report.html`
- **Features**: Interactive test results, failure details, performance metrics
- **Generated by**: pytest-html plugin

### **JSON Reports**  

- **Location**: `backend/reports/test-report.json`
- **Features**: Machine-readable test results for CI/CD integration
- **Generated by**: pytest-json-report plugin

### **CI/CD Integration**

- **GitHub Actions**: `.github/workflows/api-tests.yml`
- **Triggers**: Push to main/develop, PRs affecting notification services
- **Artifacts**: Test reports uploaded automatically
- **Comments**: PR comments with test result summaries

---

## ğŸ¯ **Sample Test Commands**

### **Basic Testing**

```bash
# Health check
curl -X GET "http://localhost:4000/api/resend/test-connection" \
  -H "Authorization: Bearer YOUR_TOKEN"

# Get preferences
curl -X GET "http://localhost:4000/api/preferences" \
  -H "Authorization: Bearer YOUR_TOKEN"

# Update preferences
curl -X PUT "http://localhost:4000/api/preferences" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"email": {"enabled": true, "alerts": true}}'
```

### **Email Testing**

```bash
# Send simple email
curl -X POST "http://localhost:4000/api/resend/send" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "to": "test@example.com",
    "subject": "API Test",
    "html": "<h1>Test</h1>",
    "text": "Test email"
  }'

# Send template email
curl -X POST "http://localhost:4000/api/resend/template" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "to": "test@example.com",
    "template": "welcome",
    "variables": {"userName": "Test User"}
  }'
```

---

## â— **Known Issues & Limitations**

### **Test Dependencies**

- Requires running backend server at configured URL
- Needs valid test user accounts in database
- Requires Resend API key for email testing (can be test key)

### **Performance Tests**

- Concurrent tests are basic (5 threads)
- For load testing, consider dedicated tools like Artillery or k6
- Database connection pool limits may affect high-concurrency tests

### **Email Tests**

- Uses real Resend service (configure test mode if needed)
- Test emails sent to configured recipient addresses
- Consider using email testing tools like MailHog for development

---

## ğŸ”„ **CI/CD Integration Examples**

### **Jenkins Pipeline**

```groovy
pipeline {
    agent any
    stages {
        stage('API Tests') {
            steps {
                sh 'cd backend && pip install -r tests/requirements-test.txt'
                sh 'cd backend && python -m pytest tests/api/test_notification_services.py --junitxml=reports/pytest.xml'
            }
            post {
                always {
                    publishTestResults testResultsPattern: 'backend/reports/pytest.xml'
                }
            }
        }
    }
}
```

### **GitLab CI**

```yaml
api_tests:
  stage: test
  script:
    - cd backend
    - pip install -r tests/requirements-test.txt
    - python -m pytest tests/api/test_notification_services.py --junitxml=reports/pytest.xml
  artifacts:
    reports:
      junit: backend/reports/pytest.xml
    paths:
      - backend/reports/
    expire_in: 1 week
```

---

## ğŸ¯ **Best Practices**

### **Test Data Management**

- Use separate test database
- Create test users with known credentials
- Clean up test data between runs
- Use factories for test data generation

### **API Testing**

- Test both positive and negative scenarios
- Validate response schemas
- Check HTTP status codes
- Verify error message formats
- Test edge cases and boundary conditions

### **Performance Testing**

- Set realistic response time thresholds
- Test with realistic data volumes
- Monitor database query performance
- Test under load conditions

### **Security Testing**

- Validate authentication enforcement
- Test authorization boundaries
- Check input sanitization
- Verify CORS policies
- Test rate limiting

---

## ğŸ“ **Support**

For issues with the testing suite:

1. Check server health: `curl http://localhost:4000/health`
2. Verify test user accounts exist in database
3. Check environment variables are configured
4. Review test reports for specific failures
5. Check backend logs for service errors

**Next Steps:**

- âœ… Backend API testing complete
- ğŸ”„ Ready for frontend UI development
- ğŸ“‹ Integration documentation ready
- ğŸ¯ CI/CD pipeline configured
