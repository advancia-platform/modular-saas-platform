# Enhanced Authentication System\n\n## Overview\n\nThis enhanced authentication system provides enterprise-grade security features for the Advancia Pay platform, including session management, token rotation, TOTP 2FA, and comprehensive audit logging.\n\n## Features\n\n### ðŸ” **Core Security Features**\n\n- **JWT with Session Management**: Enhanced security with session tracking and validation\n- **Token Rotation**: Automatic refresh token rotation to prevent reuse attacks\n- **TOTP 2FA**: Time-based One-Time Password authentication\n- **Rate Limiting**: Advanced rate limiting with per-user and per-IP tracking\n- **Audit Logging**: Comprehensive audit trail for all authentication events\n- **Multi-Device Support**: Manage sessions across multiple devices\n- **Automatic Cleanup**: Background cleanup of expired sessions and tokens\n\n### ðŸ›¡ï¸ **Security Mechanisms**\n\n1. **Access Tokens**: Short-lived (15 minutes) JWT tokens for API access\n2. **Refresh Tokens**: Long-lived (7 days) opaque tokens stored securely\n3. **Session Tracking**: Full session lifecycle management with device fingerprinting\n4. **Token Revocation**: Immediate token revocation with blacklisting\n5. **Device Management**: Track and manage sessions per device\n\n## Implementation\n\n### Database Models\n\n#### Session Model\n`prisma\nmodel Session {\n  id                 String   @id @default(cuid())\n  userId             String\n  user               User     @relation(fields: [userId], references: [id], onDelete: Cascade)\n  refreshTokenHash   String   // Bcrypt hashed refresh token\n  tokenVersion       Int      @default(1) // For rotation detection\n  userAgent          String?\n  ip                 String?\n  isRevoked          Boolean  @default(false)\n  isActive           Boolean  @default(true)\n  lastActivity       DateTime @default(now())\n  createdAt          DateTime @default(now())\n  updatedAt          DateTime @updatedAt\n  expiresAt          DateTime\n\n  @@map(\"user_sessions\")\n}\n`\n\n#### Revoked Access Tokens\n`prisma\nmodel RevokedAccessToken {\n  jti       String   @id          // JWT ID for token identification\n  userId    String\n  reason    String?\n  revokedAt DateTime @default(now())\n  exp       Int      // Expiration timestamp for cleanup\n\n  @@map(\"revoked_access_tokens\")\n}\n`\n\n#### Audit Logging\n`prisma\nmodel AuditLog {\n  id          String    @id @default(cuid())\n  userId      String\n  user        User      @relation(fields: [userId], references: [id])\n  action      String    // Action performed\n  resource    String    // Resource affected\n  resourceId  String?   // ID of affected resource\n  oldValues   String?   // Previous state (JSON)\n  newValues   String?   // New state (JSON)\n  metadata    String?   // Additional context (JSON)\n  ipAddress   String?\n  userAgent   String?\n  timestamp   DateTime  @default(now())\n\n  @@map(\"user_audit_logs\")\n}\n`\n\n### API Endpoints\n\n#### Authentication\n\n- `POST /api/auth-enhanced/register` - User registration\n- `POST /api/auth-enhanced/login` - User login with optional TOTP\n- `POST /api/auth-enhanced/refresh` - Refresh access token\n- `POST /api/auth-enhanced/logout` - Logout current session\n- `POST /api/auth-enhanced/logout-all` - Logout all sessions\n\n#### Session Management\n\n- `GET /api/auth-enhanced/sessions` - Get user's active sessions\n- `DELETE /api/auth-enhanced/sessions/:id` - Revoke specific session\n\n#### Two-Factor Authentication\n\n- `POST /api/auth-enhanced/setup-totp` - Initialize TOTP setup\n- `POST /api/auth-enhanced/verify-totp` - Verify and enable TOTP\n- `POST /api/auth-enhanced/disable-totp` - Disable TOTP\n\n### Rate Limiting Configuration\n\n`typescript\n// Login rate limiting\nconst loginLimiter = rateLimit({\n  windowMs: 10 * 60 * 1000, // 10 minutes\n  max: 20, // 20 attempts per window\n  skipSuccessfulRequests: true\n});\n\n// Registration rate limiting\nconst registrationLimiter = rateLimit({\n  windowMs: 60 * 60 * 1000, // 1 hour\n  max: 5 // 5 registrations per hour\n});\n\n// Per-user rate limiting\nconst usernameLimiter = () => {\n  // 10 attempts per 10 minutes per username\n};\n`\n\n## Usage Examples\n\n### User Registration\n\n`typescript\nconst response = await fetch('/api/auth-enhanced/register', {\n  method: 'POST',\n  headers: { 'Content-Type': 'application/json' },\n  body: JSON.stringify({\n    email: 'user@example.com',\n    password: 'SecurePassword123!',\n    username: 'johndoe',\n    firstName: 'John',\n    lastName: 'Doe'\n  })\n});\n\nconst data = await response.json();\n// Returns: user info, access token, refresh token, session ID\n`\n\n### User Login\n\n`typescript\n// Initial login\nconst loginResponse = await fetch('/api/auth-enhanced/login', {\n  method: 'POST',\n  headers: { 'Content-Type': 'application/json' },\n  body: JSON.stringify({\n    email: 'user@example.com',\n    password: 'SecurePassword123!'\n  })\n});\n\nconst loginData = await loginResponse.json();\n\n// If TOTP is required\nif (loginData.requireTotp) {\n  const totpResponse = await fetch('/api/auth-enhanced/login', {\n    method: 'POST',\n    headers: { 'Content-Type': 'application/json' },\n    body: JSON.stringify({\n      email: 'user@example.com',\n      password: 'SecurePassword123!',\n      totpToken: '123456' // From authenticator app\n    })\n  });\n}\n`\n\n### Token Refresh\n\n`typescript\nconst refreshResponse = await fetch('/api/auth-enhanced/refresh', {\n  method: 'POST',\n  headers: { 'Content-Type': 'application/json' },\n  body: JSON.stringify({\n    refreshToken: storedRefreshToken\n  })\n});\n\nconst { tokens } = await refreshResponse.json();\n// New access token and refresh token returned\n`\n\n### Session Management\n\n``typescript\n// Get active sessions\nconst sessionsResponse = await fetch('/api/auth-enhanced/sessions', {\n  headers: { 'Authorization': `Bearer ${accessToken}` }\n});\n\nconst { sessions } = await sessionsResponse.json();\n\n// Revoke a specific session\nawait fetch(`/api/auth-enhanced/sessions/${sessionId}`, {\n  method: 'DELETE',\n  headers: { 'Authorization': `Bearer ${accessToken}` }\n});\n\n// Logout from all devices\nawait fetch('/api/auth-enhanced/logout-all', {\n  method: 'POST',\n  headers: { 'Authorization': `Bearer ${accessToken}` }\n});\n``\n\n### TOTP Setup\n\n``typescript\n// 1. Initiate TOTP setup\nconst setupResponse = await fetch('/api/auth-enhanced/setup-totp', {\n  method: 'POST',\n  headers: { 'Authorization': `Bearer ${accessToken}` }\n});\n\nconst { qrCode, secret, backupCodes } = await setupResponse.json();\n\n// 2. Show QR code to user for scanning with authenticator app\n\n// 3. Verify TOTP token to enable\nconst verifyResponse = await fetch('/api/auth-enhanced/verify-totp', {\n  method: 'POST',\n  headers: { \n    'Authorization': `Bearer ${accessToken}`,\n    'Content-Type': 'application/json'\n  },\n  body: JSON.stringify({ totpToken: '123456' })\n});\n``\n\n## Security Considerations\n\n### Token Storage\n\n- **Access Token**: Store in memory or secure HTTP-only cookie\n- **Refresh Token**: Store in secure HTTP-only cookie or encrypted storage\n- **Never**: Store tokens in localStorage in production\n\n### Session Security\n\n- Sessions are tied to device fingerprints (IP + User Agent)\n- Automatic session expiry after 7 days of inactivity\n- Immediate revocation on logout or suspicious activity\n- Background cleanup of expired sessions\n\n### Rate Limiting\n\n- Multiple layers: IP-based, user-based, endpoint-specific\n- Exponential backoff for repeated failures\n- Automatic cleanup of tracking data\n\n### Audit Trail\n\n- All authentication events are logged\n- Includes device information, IP addresses, timestamps\n- Automatic retention management (90 days default)\n- Searchable and filterable audit logs\n\n## Background Services\n\n### Cleanup Service\n\nAutomatically manages:\n- Expired sessions (hourly cleanup)\n- Revoked tokens (hourly cleanup)\n- Old audit logs (daily cleanup - 90 days retention)\n- Expired signup tokens (daily cleanup)\n\n`typescript\nimport { cleanupService } from '../services/cleanupService';\n\n// Start cleanup service\ncleanupService.start();\n\n// Manual cleanup\nconst stats = await cleanupService.manualCleanup();\n\n// Get cleanup statistics\nconst cleanupStats = await cleanupService.getCleanupStats();\n`\n\n## Monitoring and Observability\n\n### Metrics to Monitor\n\n- Active sessions count\n- Failed login attempts per hour\n- Token refresh rate\n- Average session duration\n- TOTP setup/verification rates\n\n### Alerts to Configure\n\n- High failed login attempts from single IP\n- Unusual token refresh patterns\n- Multiple sessions from different locations\n- Failed TOTP attempts above threshold\n\n### Audit Log Analysis\n\n`sql\n-- Failed login attempts in last hour\nSELECT COUNT(*) FROM user_audit_logs \nWHERE action = 'failed_login_attempt' \nAND timestamp > NOW() - INTERVAL '1 hour';\n\n-- Sessions created per day\nSELECT DATE(timestamp) as date, COUNT(*) as sessions_created\nFROM user_audit_logs \nWHERE action = 'successful_login'\nGROUP BY DATE(timestamp)\nORDER BY date DESC;\n`\n\n## Migration Guide\n\n### From Existing Auth System\n\n1. **Database Migration**:\n `bash\n   npx prisma migrate dev --name enhanced-authentication-system\n`\n\n2. **Update Environment Variables**:\n `env\n   JWT_SECRET=your-rs256-private-key\n   # Add any additional configuration\n`\n\n3. **Update Authentication Middleware**:\n `typescript\n   // Replace old auth middleware\n   import { authenticateTokenWithSession } from './middleware/auth';\n   \n   router.use('/api/protected', authenticateTokenWithSession);\n`\n\n4. **Start Background Services**:\n `typescript\n   import { cleanupService } from './services/cleanupService';\n   \n   // In your app initialization\n   cleanupService.start();\n`\n\n### Testing\n\n`typescript\n// Test session creation\nconst session = await sessionManager.createSession(\n  userId, userEmail, userRole, mockRequest\n);\n\n// Test token refresh\nconst newTokens = await sessionManager.refreshTokens(\n  session.refreshToken, mockRequest\n);\n\n// Test session revocation\nawait sessionManager.revokeSession(session.sessionId);\n`\n\n## Troubleshooting\n\n### Common Issues\n\n1. **\"Session expired\" errors**:\n - Check if cleanup service is running too frequently\n - Verify session expiry times are reasonable\n - Check for clock skew between servers\n\n2. **Rate limiting issues**:\n - Review rate limit configuration\n - Check if cleanup is working for rate limit stores\n - Consider IP whitelisting for admin users\n\n3. **TOTP verification failures**:\n - Ensure server and client clocks are synchronized\n - Check TOTP window configuration\n - Verify QR code generation is correct\n\n### Debug Logging\n\n`typescript\n// Enable debug logging\nlogger.level = 'debug';\n\n// Check session manager logs\nlogger.debug('Session created', { sessionId, userId });\nlogger.debug('Token refreshed', { sessionId, tokenVersion });\n`\n\nThis enhanced authentication system provides a solid foundation for secure user authentication with enterprise-grade features. It can be extended with additional security measures as needed
