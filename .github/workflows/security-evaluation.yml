name: Security Evaluation

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  schedule:
    - cron: "0 2 * * 1" # Weekly on Monday at 2 AM UTC
  workflow_dispatch: # Allow manual trigger

jobs:
  security-evaluation:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: advancia_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "npm"
          cache-dependency-path: backend/package-lock.json

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"
          cache-dependency-path: evaluation/requirements.txt

      - name: Install backend dependencies
        working-directory: backend
        run: npm ci --legacy-peer-deps

      - name: Setup database
        working-directory: backend
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/advancia_test
        run: |
          npx prisma generate
          npx prisma migrate deploy
          echo "Database setup complete"

      - name: Build backend
        working-directory: backend
        run: npm run build

      - name: Start backend server
        working-directory: backend
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/advancia_test
          JWT_SECRET: test-jwt-secret-for-ci-only
          NODE_ENV: test
          PORT: 4000
          RESEND_API_KEY: ${{ secrets.RESEND_API_KEY }}
          EMAIL_USER: test@advancia.test
          EMAIL_PASSWORD: test-password
          SMTP_HOST: localhost
          SMTP_PORT: 587
        run: |
          npm start &
          echo "Waiting for backend to be ready..."
          timeout 60 bash -c 'until curl -f http://localhost:4000/health 2>/dev/null; do sleep 2; done'
          echo "âœ… Backend is ready"

      - name: Install evaluation dependencies
        working-directory: evaluation
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run security evaluation
        working-directory: evaluation
        env:
          BACKEND_URL: http://localhost:4000
          TEST_EMAIL: evaltest@advancia.test
          TEST_PASSWORD: EvalTest123!@#Secure
          VERBOSE: "true"
          ENABLE_AUDIT_LOGGING: "true"
          MIN_SECURITY_SCORE: "80"
        run: |
          python run_evaluation.py --report json --output results/ci-evaluation
          echo "âœ… Evaluation complete"

      - name: Check security score
        working-directory: evaluation
        run: |
          SCORE=$(python -c "import json; print(json.load(open('results/ci-evaluation.json'))['overall_score'])")
          echo "ðŸ”’ Security Score: $SCORE/100"

          if [ "$SCORE" -lt 80 ]; then
            echo "âŒ Security score $SCORE is below minimum threshold (80)"
            exit 1
          fi

          echo "âœ… Security score meets requirements"

      - name: Upload evaluation results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: security-evaluation-results
          path: |
            evaluation/results/ci-evaluation.json
            evaluation/results/ci-evaluation_audit.json
          retention-days: 30

      - name: Comment on PR with results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');

            const resultsPath = path.join(process.env.GITHUB_WORKSPACE, 'evaluation/results/ci-evaluation.json');
            const results = JSON.parse(fs.readFileSync(resultsPath, 'utf8'));

            const scoreEmoji = results.overall_score >= 90 ? 'ðŸŸ¢' : results.overall_score >= 80 ? 'ðŸŸ¡' : 'ðŸ”´';

            const categoryScores = Object.entries(results.category_scores)
              .map(([category, data]) => {
                const categoryEmoji = data.score >= 90 ? 'âœ…' : data.score >= 70 ? 'âš ï¸' : 'âŒ';
                return `${categoryEmoji} **${category}**: ${data.score}/100 (${data.passed}/${data.passed + data.failed} passed)`;
              })
              .join('\n');

            const issuesSection = results.issues_found.length > 0 ? `
            ### âš ï¸ Issues Found (${results.issues_found.length})
            ${results.issues_found.slice(0, 5).map(issue =>
              `- **[${issue.severity.toUpperCase()}]** ${issue.message}`
            ).join('\n')}
            ${results.issues_found.length > 5 ? `\n_... and ${results.issues_found.length - 5} more issues_` : ''}
            ` : 'âœ… **No security issues found!**';

            const comment = `## ðŸ”’ Security Evaluation Results

            ${scoreEmoji} **Overall Score:** ${results.overall_score}/100
            ðŸ“Š **Tests:** ${results.summary.passed}/${results.summary.total_tests} passed
            â±ï¸ **Duration:** ${results.test_duration_seconds}s

            ### Category Breakdown
            ${categoryScores}

            ${issuesSection}

            ### ðŸ“‹ Compliance Status
            - **PCI-DSS Ready:** ${results.security_compliance?.pci_dss_ready ? 'âœ…' : 'âŒ'}
            - **GDPR Compliant:** ${results.security_compliance?.gdpr_compliant ? 'âœ…' : 'âŒ'}
            - **Audit Logging:** ${results.security_compliance?.audit_logging_enabled ? 'âœ…' : 'âŒ'}

            ---
            _Full results available in workflow artifacts_
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      - name: Generate summary
        if: always()
        run: |
          cd evaluation
          python -c "
          import json
          with open('results/ci-evaluation.json') as f:
              results = json.load(f)

          print('## ðŸ”’ Security Evaluation Summary')
          print(f\"Overall Score: {results['overall_score']}/100\")
          print(f\"Tests Passed: {results['summary']['passed']}/{results['summary']['total_tests']}\")
          print(f\"Duration: {results['test_duration_seconds']}s\")
          print()
          print('### Category Scores:')
          for cat, data in results['category_scores'].items():
              print(f\"- {cat}: {data['score']}/100\")
          " >> $GITHUB_STEP_SUMMARY
