name: ğŸ§ª Notification Services API Tests

on:
  push:
    branches: [main, develop, "feature/**"]
    paths:
      - "backend/src/routes/preferences.ts"
      - "backend/src/routes/resend.ts"
      - "backend/src/services/resendService.ts"
      - "backend/tests/api/**"
  pull_request:
    branches: [main, develop]
    paths:
      - "backend/src/routes/preferences.ts"
      - "backend/src/routes/resend.ts"
      - "backend/src/services/resendService.ts"
      - "backend/tests/api/**"

jobs:
  api-tests:
    name: API Integration Tests
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: advancia_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

      redis:
        image: redis:7-alpine
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379

    env:
      DATABASE_URL: postgresql://postgres:postgres@localhost:5432/advancia_test
      JWT_SECRET: test-jwt-secret-key-for-ci
      RESEND_API_KEY: ${{ secrets.RESEND_API_KEY_TEST }}
      NODE_ENV: test
      REDIS_URL: redis://localhost:6379

    steps:
      - name: ğŸ›’ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: backend/package-lock.json

      - name: ğŸ”§ Install backend dependencies
        working-directory: ./backend
        run: |
          npm ci
          npm install -g ts-node typescript

      - name: ğŸ—„ï¸ Setup test database
        working-directory: ./backend
        run: |
          npx prisma migrate deploy
          npx prisma generate

      - name: ğŸ—ï¸ Build backend
        working-directory: ./backend
        run: npm run build

      - name: ğŸš€ Start backend server
        working-directory: ./backend
        run: |
          npm run dev &
          echo $! > server.pid
          sleep 10  # Wait for server to start

      - name: ğŸ” Wait for server health
        run: |
          timeout 30 bash -c 'until curl -f http://localhost:4000/health; do sleep 1; done'

      - name: ğŸ Setup Python for API tests
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: ğŸ“¦ Install Python test dependencies
        working-directory: ./backend
        run: |
          python -m pip install --upgrade pip
          pip install -r tests/requirements-test.txt

      - name: ğŸ§ª Run API tests
        working-directory: ./backend
        env:
          API_BASE_URL: http://localhost:4000
          TEST_USER_EMAIL: test@example.com
          TEST_USER_PASSWORD: testPassword123
          TEST_ADMIN_EMAIL: admin@example.com
          TEST_ADMIN_PASSWORD: adminPassword123
        run: |
          pytest tests/api/test_notification_services.py \
            -v \
            --html=reports/test-report.html \
            --self-contained-html \
            --json-report \
            --json-report-file=reports/test-report.json \
            --timeout=300 \
            --maxfail=5

      - name: ğŸ“Š Upload test reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: api-test-reports-${{ github.run_id }}
          path: |
            backend/reports/test-report.html
            backend/reports/test-report.json
          retention-days: 30

      - name: ğŸ›‘ Stop backend server
        if: always()
        working-directory: ./backend
        run: |
          if [ -f server.pid ]; then
            kill $(cat server.pid) || true
            rm server.pid
          fi

      - name: ğŸ“‹ Comment test results on PR
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = './backend/reports/test-report.json';

            if (fs.existsSync(path)) {
              const report = JSON.parse(fs.readFileSync(path, 'utf8'));
              const { summary } = report;

              const passed = summary.passed || 0;
              const failed = summary.failed || 0;
              const total = summary.total || 0;

              const status = failed === 0 ? 'âœ… PASSED' : 'âŒ FAILED';

              const comment = `
              ## ğŸ§ª API Tests Results

              **Status:** ${status}

              **Summary:**
              - âœ… Passed: ${passed}
              - âŒ Failed: ${failed}
              - ğŸ“Š Total: ${total}

              **Test Coverage:**
              - Notification Preferences API
              - Resend Email Service Integration
              - Authentication & RBAC
              - Input Validation
              - Error Handling

              [ğŸ“‹ View detailed report in artifacts](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
              `;

              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment
              });
            }

  performance-tests:
    name: Performance Tests
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop')
    needs: api-tests

    steps:
      - name: ğŸ›’ Checkout code
        uses: actions/checkout@v4

      - name: ğŸš€ Run performance tests
        run: |
          echo "ğŸš€ Performance tests would run here"
          echo "Consider integrating with tools like Artillery, k6, or Apache JMeter"
