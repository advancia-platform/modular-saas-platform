name: Emergency Rollback Notifications

on:
  workflow_dispatch:
    inputs:
      rollback_reason:
        description: 'Reason for rollback'
        required: true
        type: choice
        options:
          - security-incident
          - service-outage
          - deployment-failure
          - data-integrity-issue
          - performance-degradation
          - other
      severity:
        description: 'Incident severity'
        required: true
        type: choice
        options:
          - critical
          - high
          - medium
          - low
      affected_services:
        description: 'Affected services (comma-separated)'
        required: true
        type: string
        default: 'backend,frontend'
      rollback_commit:
        description: 'Commit SHA to rollback to'
        required: true
        type: string
      incident_commander:
        description: 'Incident commander'
        required: true
        type: string
      estimated_downtime:
        description: 'Estimated downtime (minutes)'
        required: false
        type: string
        default: '15'

env:
  INCIDENT_ID: ${{ github.run_id }}-rollback
  ROLLBACK_TIMESTAMP: ${{ github.event.created_at }}
  SEVERITY: ${{ github.event.inputs.severity }}
  REASON: ${{ github.event.inputs.rollback_reason }}

jobs:
  create-incident-issue:
    runs-on: ubuntu-latest
    outputs:
      issue-number: ${{ steps.create-issue.outputs.issue-number }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Create Incident Tracking Issue
        id: create-issue
        uses: actions/github-script@v7
        with:
          script: |
            const severity = process.env.SEVERITY;
            const reason = process.env.REASON;
            const incidentId = process.env.INCIDENT_ID;
            const services = '${{ github.event.inputs.affected_services }}';
            const commander = '${{ github.event.inputs.incident_commander }}';
            const downtime = '${{ github.event.inputs.estimated_downtime }}';
            const rollbackCommit = '${{ github.event.inputs.rollback_commit }}';

            const severityEmoji = {
              'critical': 'ðŸš¨',
              'high': 'âš ï¸',
              'medium': 'âš¡',
              'low': 'â„¹ï¸'
            };

            const issueBody = `
            # ${severityEmoji[severity]} Emergency Rollback Initiated

            **Incident ID:** \`${incidentId}\`
            **Severity:** ${severity.toUpperCase()}
            **Incident Commander:** @${commander}
            **Rollback Initiated:** ${new Date().toISOString()}
            **Estimated Downtime:** ${downtime} minutes

            ## Incident Details
            - **Reason:** ${reason.replace('-', ' ')}
            - **Affected Services:** ${services}
            - **Rollback Target:** \`${rollbackCommit}\`
            - **Triggered By:** @${{ github.actor }}

            ## Immediate Actions Checklist
            ### 1. Communication
            - [ ] PagerDuty incident created (auto)
            - [ ] Slack #incidents channel notified (auto)
            - [ ] Teams stakeholders notified (auto)
            - [ ] Customer support team informed
            - [ ] Status page updated if customer-facing

            ### 2. Technical Response
            - [ ] Rollback deployment initiated
            - [ ] Database migration rollback (if needed)
            - [ ] Cache cleared/invalidated
            - [ ] CDN purged (if needed)
            - [ ] Health checks verified

            ### 3. Monitoring
            - [ ] Error rates returning to normal
            - [ ] Response times improved
            - [ ] User complaints stopped
            - [ ] SLA metrics stabilized

            ### 4. Investigation
            - [ ] Root cause analysis started
            - [ ] Timeline documented
            - [ ] Impact assessment completed
            - [ ] Lessons learned captured

            ## Escalation Contacts
            - **Platform Lead:** @platform-lead
            - **Engineering Manager:** @eng-manager
            - **CTO:** @cto (critical incidents only)
            - **Customer Success:** @customer-success

            ## Timeline
            | Time | Action | Status |
            |------|--------|--------|
            | ${new Date().toISOString()} | Rollback initiated | âœ… |
            | | Service health verified | â³ |
            | | Customer communication sent | â³ |
            | | Post-incident review scheduled | â³ |

            ---

            **Next Steps:** Update timeline above as actions are completed.
            `;

            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `${severityEmoji[severity]} ROLLBACK: ${reason} - ${incidentId}`,
              body: issueBody,
              labels: ['incident', 'rollback', severity, reason],
              assignees: [commander]
            });

            return issue.data.number;

  trigger-pagerduty:
    runs-on: ubuntu-latest
    needs: create-incident-issue

    steps:
      - name: Create PagerDuty Incident
        run: |
          # Determine severity mapping
          case "${{ env.SEVERITY }}" in
            "critical") PD_SEVERITY="critical" ;;
            "high") PD_SEVERITY="error" ;;
            "medium") PD_SEVERITY="warning" ;;
            "low") PD_SEVERITY="info" ;;
            *) PD_SEVERITY="error" ;;
          esac

          curl -X POST "https://events.pagerduty.com/v2/enqueue" \
            -H "Content-Type: application/json" \
            -d '{
              "routing_key": "${{ secrets.PAGERDUTY_ROUTING_KEY }}",
              "event_action": "trigger",
              "payload": {
                "summary": "EMERGENCY ROLLBACK: ${{ env.REASON }} - Severity: ${{ env.SEVERITY }}",
                "severity": "'$PD_SEVERITY'",
                "source": "GitHub Actions Emergency Response",
                "component": "deployment",
                "group": "advancia-pay",
                "class": "rollback",
                "custom_details": {
                  "incident_id": "${{ env.INCIDENT_ID }}",
                  "rollback_reason": "${{ env.REASON }}",
                  "severity": "${{ env.SEVERITY }}",
                  "affected_services": "${{ github.event.inputs.affected_services }}",
                  "incident_commander": "${{ github.event.inputs.incident_commander }}",
                  "rollback_commit": "${{ github.event.inputs.rollback_commit }}",
                  "estimated_downtime": "${{ github.event.inputs.estimated_downtime }} minutes",
                  "github_issue": "${{ github.server_url }}/${{ github.repository }}/issues/${{ needs.create-incident-issue.outputs.issue-number }}",
                  "workflow_run": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                }
              }
            }'

  notify-slack:
    runs-on: ubuntu-latest
    needs: create-incident-issue

    steps:
      - name: Slack Critical Alert
        description: "Send urgent notifications to team"
        required: true
        type: boolean
        default: true

jobs:
  emergency-rollback:
    name: Execute Emergency Rollback
    runs-on: ubuntu-latest

    steps:
      - name: Determine current and target environments
        id: environments
        run: |
          # Get current production IP
          current_ip=$(dig +short api.advancia.com | head -n1)

          # Determine which is current and which is rollback target
          if [ "$current_ip" == "${{ secrets.DROPLET_IP_GREEN }}" ]; then
            echo "CURRENT_ENV=ðŸŸ¢ Green" >> $GITHUB_OUTPUT
            echo "ROLLBACK_ENV=ðŸ”µ Blue" >> $GITHUB_OUTPUT
            echo "ROLLBACK_IP=${{ secrets.DROPLET_IP_BLUE }}" >> $GITHUB_OUTPUT
            echo "ROLLBACK_URL=https://blue.advancia.com" >> $GITHUB_OUTPUT
          else
            echo "CURRENT_ENV=ðŸ”µ Blue" >> $GITHUB_OUTPUT
            echo "ROLLBACK_ENV=ðŸŸ¢ Green" >> $GITHUB_OUTPUT
            echo "ROLLBACK_IP=${{ secrets.DROPLET_IP_GREEN }}" >> $GITHUB_OUTPUT
            echo "ROLLBACK_URL=https://green.advancia.com" >> $GITHUB_OUTPUT
          fi

      - name: Send urgent alert
        if: github.event.inputs.notify_team == 'true'
        run: |
          curl -X POST -H 'Content-type: application/json' \
          --data "{\"text\":\"ðŸš¨ *EMERGENCY ROLLBACK INITIATED* ðŸš¨\n\n*Current Environment:* ${{ steps.environments.outputs.CURRENT_ENV }}\n*Rolling back to:* ${{ steps.environments.outputs.ROLLBACK_ENV }}\n*Reason:* ${{ github.event.inputs.reason }}\n*Initiated by:* ${{ github.actor }}\n*Status:* IN PROGRESS\n\n@channel - Production rollback in progress\"}" \
          ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: Verify rollback target health
        run: |
          echo "Checking rollback target health..."
          if curl -f -s "${{ steps.environments.outputs.ROLLBACK_URL }}/api/health" | grep -q "ok"; then
            echo "âœ… Rollback target is healthy"
          else
            echo "âš ï¸ WARNING: Rollback target may have issues"
            curl -X POST -H 'Content-type: application/json' \
            --data "{\"text\":\"âš ï¸ Rollback target health check failed but continuing with rollback...\"}" \
            ${{ secrets.SLACK_WEBHOOK_URL }}
          fi

      - name: Switch DNS to rollback environment
        run: |
          # Update production DNS immediately
          curl -X PATCH "https://api.cloudflare.com/client/v4/zones/${{ secrets.CF_ZONE_ID }}/dns_records/${{ secrets.CF_PROD_RECORD_ID }}" \
          -H "Authorization: Bearer ${{ secrets.CF_API_TOKEN }}" \
          -H "Content-Type: application/json" \
          --data "{\"type\":\"A\",\"name\":\"api.advancia.com\",\"content\":\"${{ steps.environments.outputs.ROLLBACK_IP }}\",\"ttl\":60,\"proxied\":true}"

          # Update www
          curl -X PATCH "https://api.cloudflare.com/client/v4/zones/${{ secrets.CF_ZONE_ID }}/dns_records/${{ secrets.CF_WWW_RECORD_ID }}" \
          -H "Authorization: Bearer ${{ secrets.CF_API_TOKEN }}" \
          -H "Content-Type: application/json" \
          --data "{\"type\":\"A\",\"name\":\"www.advancia.com\",\"content\":\"${{ steps.environments.outputs.ROLLBACK_IP }}\",\"ttl\":60,\"proxied\":true}"

          echo "âœ… DNS switched to rollback environment"

      - name: Verify rollback
        run: |
          sleep 15

          max_attempts=30
          attempt=0

          while [ $attempt -lt $max_attempts ]; do
            if curl -f -s "https://api.advancia.com/api/health" | grep -q "ok"; then
              echo "âœ… Rollback successful - production responding"
              exit 0
            fi
            echo "Attempt $((attempt+1))/$max_attempts - Waiting for DNS propagation..."
            sleep 2
            attempt=$((attempt+1))
          done

          echo "âš ï¸ Production verification taking longer than expected"

      - name: Rollback success notification
        if: success()
        run: |
          curl -X POST -H 'Content-type: application/json' \
          --data "{\"text\":\"âœ… *EMERGENCY ROLLBACK COMPLETE*\n\n*From:* ${{ steps.environments.outputs.CURRENT_ENV }}\n*To:* ${{ steps.environments.outputs.ROLLBACK_ENV }}\n*Reason:* ${{ github.event.inputs.reason }}\n*Time:* $(date -u +'%Y-%m-%d %H:%M:%S UTC')\n*Duration:* ~1 minute\n\nâœ… Production is now stable\n\n*Next Steps:*\n1. Investigate issue in ${{ steps.environments.outputs.CURRENT_ENV }}\n2. Fix problems before redeploying\n3. Monitor metrics closely\"}" \
          ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: Create incident report
        run: |
          cat > incident_report.txt << EOF
          EMERGENCY ROLLBACK INCIDENT REPORT
          ==================================

          Date/Time: $(date -u +'%Y-%m-%d %H:%M:%S UTC')
          Triggered by: ${{ github.actor }}
          Reason: ${{ github.event.inputs.reason }}

          Environment Changes:
          - Previous: ${{ steps.environments.outputs.CURRENT_ENV }}
          - Current: ${{ steps.environments.outputs.ROLLBACK_ENV }}

          Actions Taken:
          1. DNS switched to rollback environment
          2. Health checks verified
          3. Production confirmed stable

          Status: RESOLVED

          Follow-up Required:
          - Root cause analysis
          - Fix issues in rolled-back environment
          - Plan for redeployment
          EOF

          echo "Incident report created"

      - name: Rollback failure notification
        if: failure()
        run: |
          curl -X POST -H 'Content-type: application/json' \
          --data "{\"text\":\"ðŸ”´ *CRITICAL: ROLLBACK FAILED* ðŸ”´\n\n*Status:* FAILED\n*Reason:* ${{ github.event.inputs.reason }}\n\n@channel IMMEDIATE ACTION REQUIRED\n\nBoth environments may be unstable.\nContact DevOps team NOW!\"}" \
          ${{ secrets.SLACK_WEBHOOK_URL }}
