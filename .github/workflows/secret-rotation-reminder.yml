name: Secret Rotation Reminder & Management

on:
  schedule:
    - cron: "0 9 */90 * *" # Every 90 days at 9 AM UTC
  workflow_dispatch: # Manual trigger
    inputs:
      rotation_type:
        description: "Type of rotation"
        required: true
        default: "scheduled"
        type: choice
        options:
          - scheduled
          - emergency
          - compromise
      secrets_to_rotate:
        description: "Secrets to rotate (comma-separated)"
        required: false
        default: "ALL"
        type: string
      engineer_contact:
        description: "Engineer responsible for rotation"
        required: true
        type: string

env:
  ROTATION_DATE: ${{ github.run_id }}-${{ github.run_number }}
  ENGINEER_RESPONSIBLE: ${{ github.actor }}
  ROTATION_TYPE: ${{ github.event.inputs.rotation_type || 'scheduled' }}

jobs:
  create-rotation-issue:
    runs-on: ubuntu-latest
    outputs:
      issue-number: ${{ steps.create-issue.outputs.issue-number }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Create Secret Rotation Issue
        id: create-issue
        uses: actions/github-script@v7
        with:
          script: |
            const rotationType = process.env.ROTATION_TYPE;
            const engineer = process.env.ENGINEER_RESPONSIBLE;
            const runId = process.env.ROTATION_DATE;

            const issueBody = `
            # üîë Secret Rotation Required

            **Rotation ID:** \`${runId}\`
            **Type:** ${rotationType}
            **Assigned Engineer:** @${engineer}
            **Due Date:** ${new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0]}

            ## Secrets to Rotate
            - [ ] \`PAGERDUTY_ROUTING_KEY\`
            - [ ] \`SLACK_WEBHOOK_URL\`
            - [ ] \`TEAMS_WEBHOOK_URL\`
            - [ ] \`GRAFANA_ADMIN_PASSWORD\`
            - [ ] \`DATABASE_ENCRYPTION_KEY\` (if applicable)

            ## Checklist
            ### 1. Preparation
            - [ ] Review current secret values and expiration dates
            - [ ] Generate new keys/webhooks in respective platforms
            - [ ] Store new values securely in password manager
            - [ ] Notify team of upcoming rotation window

            ### 2. GitHub Secrets Update
            - [ ] Navigate to Settings ‚Üí Secrets and variables ‚Üí Actions
            - [ ] Update \`PAGERDUTY_ROUTING_KEY\` with new integration key
            - [ ] Update \`SLACK_WEBHOOK_URL\` with new webhook URL
            - [ ] Update \`TEAMS_WEBHOOK_URL\` with new webhook URL
            - [ ] Confirm secret names remain unchanged

            ### 3. Validation
            - [ ] Run validation workflow: \`Secret Rotation Validation\`
            - [ ] Verify Slack channel receives test alert
            - [ ] Verify Teams channel receives test alert
            - [ ] Verify PagerDuty incident creation
            - [ ] Check GitHub Actions logs for successful secret injection

            ### 4. Cleanup
            - [ ] Deactivate old keys/webhooks in external platforms
            - [ ] Document rotation in security log
            - [ ] Update next rotation date (90 days from now)

            ### 5. Communication
            - [ ] Notify ops team of completion
            - [ ] Update compliance documentation
            - [ ] Close this issue with summary

            ## Validation Commands
            \`\`\`bash
            # Test all notification channels
            gh workflow run "Secret Rotation Validation" --ref main
            \`\`\`

            ## Emergency Contacts
            - **Platform Lead:** @platform-lead
            - **Security Team:** @security-team
            - **On-Call Engineer:** Check PagerDuty schedule

            ---

            **‚ö†Ô∏è Important:** Complete rotation within 7 days to maintain security compliance.
            `;

            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `üîë Secret Rotation Required - ${rotationType.toUpperCase()} (${runId})`,
              body: issueBody,
              labels: ['security', 'secret-rotation', rotationType],
              assignees: [engineer]
            });

            return issue.data.number;

  notify-channels:
    runs-on: ubuntu-latest
    needs: create-rotation-issue

    steps:
      - name: Notify PagerDuty
        run: |
          SEVERITY="info"
          if [ "${{ env.ROTATION_TYPE }}" = "emergency" ] || [ "${{ env.ROTATION_TYPE }}" = "compromise" ]; then
            SEVERITY="warning"
          fi

          curl -X POST "https://events.pagerduty.com/v2/enqueue" \
            -H "Content-Type: application/json" \
            -d '{
              "routing_key": "${{ secrets.PAGERDUTY_ROUTING_KEY }}",
              "event_action": "trigger",
              "payload": {
                "summary": "Secret rotation required - ${{ env.ROTATION_TYPE }}",
                "severity": "'$SEVERITY'",
                "source": "GitHub Actions Secret Management",
                "component": "ci-cd",
                "group": "advancia-pay",
                "class": "security",
                "custom_details": {
                  "rotation_id": "${{ env.ROTATION_DATE }}",
                  "rotation_type": "${{ env.ROTATION_TYPE }}",
                  "engineer_responsible": "${{ env.ENGINEER_RESPONSIBLE }}",
                  "issue_number": "${{ needs.create-rotation-issue.outputs.issue-number }}",
                  "due_date": "${{ env.DUE_DATE }}",
                  "github_issue": "${{ github.server_url }}/${{ github.repository }}/issues/${{ needs.create-rotation-issue.outputs.issue-number }}"
                }
              }
            }'

      - name: Notify Slack
        run: |
          URGENCY_COLOR="#ffaa00"
          if [ "${{ env.ROTATION_TYPE }}" = "emergency" ] || [ "${{ env.ROTATION_TYPE }}" = "compromise" ]; then
            URGENCY_COLOR="#ff0000"
          fi

          curl -X POST "${{ secrets.SLACK_WEBHOOK_URL }}" \
            -H "Content-Type: application/json" \
            -d '{
              "text": "üîë Secret Rotation Required",
              "attachments": [
                {
                  "color": "'$URGENCY_COLOR'",
                  "blocks": [
                    {
                      "type": "header",
                      "text": {
                        "type": "plain_text",
                        "text": "üîë Secret Rotation Required"
                      }
                    },
                    {
                      "type": "section",
                      "fields": [
                        {
                          "type": "mrkdwn",
                          "text": "*Rotation Type:* ${{ env.ROTATION_TYPE }}"
                        },
                        {
                          "type": "mrkdwn",
                          "text": "*Assigned Engineer:* @${{ env.ENGINEER_RESPONSIBLE }}"
                        },
                        {
                          "type": "mrkdwn",
                          "text": "*Rotation ID:* `${{ env.ROTATION_DATE }}`"
                        },
                        {
                          "type": "mrkdwn",
                          "text": "*Due Date:* 7 days from now"
                        }
                      ]
                    },
                    {
                      "type": "section",
                      "text": {
                        "type": "mrkdwn",
                        "text": "Secrets to rotate: `PAGERDUTY_ROUTING_KEY`, `SLACK_WEBHOOK_URL`, `TEAMS_WEBHOOK_URL`"
                      }
                    },
                    {
                      "type": "actions",
                      "elements": [
                        {
                          "type": "button",
                          "text": {
                            "type": "plain_text",
                            "text": "View Issue"
                          },
                          "url": "${{ github.server_url }}/${{ github.repository }}/issues/${{ needs.create-rotation-issue.outputs.issue-number }}"
                        },
                        {
                          "type": "button",
                          "text": {
                            "type": "plain_text",
                            "text": "Rotation Docs"
                          },
                          "url": "${{ github.server_url }}/${{ github.repository }}/blob/main/docs/security/SECRET_ROTATION_GUIDE.md"
                        }
                      ]
                    }
                  ]
                }
              ]
            }'

      - name: Notify Teams
        run: |
          THEME_COLOR="ffaa00"
          if [ "${{ env.ROTATION_TYPE }}" = "emergency" ] || [ "${{ env.ROTATION_TYPE }}" = "compromise" ]; then
            THEME_COLOR="ff0000"
          fi

          curl -X POST "${{ secrets.TEAMS_WEBHOOK_URL }}" \
            -H "Content-Type: application/json" \
            -d '{
              "type": "message",
              "attachments": [
                {
                  "contentType": "application/vnd.microsoft.card.adaptive",
                  "content": {
                    "$schema": "http://adaptivecards.io/schemas/adaptive-card.json",
                    "type": "AdaptiveCard",
                    "version": "1.0",
                    "body": [
                      {
                        "type": "TextBlock",
                        "text": "üîë Secret Rotation Required",
                        "size": "Large",
                        "weight": "Bolder"
                      },
                      {
                        "type": "FactSet",
                        "facts": [
                          {
                            "title": "Rotation Type",
                            "value": "${{ env.ROTATION_TYPE }}"
                          },
                          {
                            "title": "Assigned Engineer",
                            "value": "${{ env.ENGINEER_RESPONSIBLE }}"
                          },
                          {
                            "title": "Rotation ID",
                            "value": "${{ env.ROTATION_DATE }}"
                          },
                          {
                            "title": "Due Date",
                            "value": "7 days from now"
                          }
                        ]
                      },
                      {
                        "type": "TextBlock",
                        "text": "**Secrets to rotate:**\n- PAGERDUTY_ROUTING_KEY\n- SLACK_WEBHOOK_URL\n- TEAMS_WEBHOOK_URL",
                        "wrap": true
                      }
                    ],
                    "actions": [
                      {
                        "type": "Action.OpenUrl",
                        "title": "View GitHub Issue",
                        "url": "${{ github.server_url }}/${{ github.repository }}/issues/${{ needs.create-rotation-issue.outputs.issue-number }}"
                      },
                      {
                        "type": "Action.OpenUrl",
                        "title": "Rotation Guide",
                        "url": "${{ github.server_url }}/${{ github.repository }}/blob/main/docs/security/SECRET_ROTATION_GUIDE.md"
                      }
                    ]
                  }
                }
              ]
            }'

  schedule-followup:
    runs-on: ubuntu-latest
    needs: [create-rotation-issue, notify-channels]

    steps:
      - name: Schedule Follow-up Reminder
        uses: actions/github-script@v7
        with:
          script: |
            // Schedule a follow-up comment in 5 days if issue is still open
            const issue_number = ${{ needs.create-rotation-issue.outputs.issue-number }};

            setTimeout(async () => {
              const issue = await github.rest.issues.get({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue_number
              });

              if (issue.data.state === 'open') {
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue_number,
                  body: `
                  ## üö® Follow-up Reminder

                  This secret rotation has been open for 5 days. **Due date is in 2 days.**

                  **Current Status:** Please update the checklist above with your progress.

                  If you're encountering issues, please:
                  1. Tag @platform-lead for assistance
                  2. Check the [Secret Rotation Guide](../docs/security/SECRET_ROTATION_GUIDE.md)
                  3. Run validation workflow to test changes

                  **‚ö†Ô∏è Overdue rotations will be escalated to security team.**
                  `
                });
              }
            }, 5 * 24 * 60 * 60 * 1000); // 5 days
