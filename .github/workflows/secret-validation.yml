name: Secret Validation Testing

on:
  workflow_dispatch:
    inputs:
      test_type:
        description: "Type of validation test"
        required: true
        type: choice
        options:
          - all-channels
          - pagerduty-only
          - slack-only
          - teams-only
      test_message:
        description: "Custom test message"
        required: false
        type: string
        default: "Secret rotation validation test"

jobs:
  validate-pagerduty:
    runs-on: ubuntu-latest
    if: github.event.inputs.test_type == 'all-channels' || github.event.inputs.test_type == 'pagerduty-only'

    steps:
      - name: Test PagerDuty Integration
        run: |
          echo "Testing PagerDuty integration..."

          response=$(curl -s -o /dev/null -w "%{http_code}" -X POST "https://events.pagerduty.com/v2/enqueue" \
            -H "Content-Type: application/json" \
            -d '{
              "routing_key": "${{ secrets.PAGERDUTY_ROUTING_KEY }}",
              "event_action": "trigger",
              "payload": {
                "summary": "VALIDATION TEST: ${{ github.event.inputs.test_message }}",
                "severity": "info",
                "source": "Secret Rotation Validation",
                "component": "testing",
                "group": "advancia-pay",
                "class": "validation",
                "custom_details": {
                  "test_type": "secret_validation",
                  "workflow_run": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}",
                  "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
                  "engineer": "${{ github.actor }}"
                }
              }
            }')

          if [ "$response" = "202" ]; then
            echo "‚úÖ PagerDuty test successful (HTTP $response)"
          else
            echo "‚ùå PagerDuty test failed (HTTP $response)"
            exit 1
          fi

  validate-slack:
    runs-on: ubuntu-latest
    if: github.event.inputs.test_type == 'all-channels' || github.event.inputs.test_type == 'slack-only'

    steps:
      - name: Test Slack Integration
        run: |
          echo "Testing Slack integration..."

          response=$(curl -s -o /dev/null -w "%{http_code}" -X POST "${{ secrets.SLACK_WEBHOOK_URL }}" \
            -H "Content-Type: application/json" \
            -d '{
              "text": "üîß Secret Rotation Validation Test",
              "attachments": [
                {
                  "color": "#36a64f",
                  "blocks": [
                    {
                      "type": "header",
                      "text": {
                        "type": "plain_text",
                        "text": "üîß Secret Validation Test"
                      }
                    },
                    {
                      "type": "section",
                      "fields": [
                        {
                          "type": "mrkdwn",
                          "text": "*Test Type:* Secret Rotation Validation"
                        },
                        {
                          "type": "mrkdwn",
                          "text": "*Status:* Testing Slack Integration"
                        },
                        {
                          "type": "mrkdwn",
                          "text": "*Engineer:* ${{ github.actor }}"
                        },
                        {
                          "type": "mrkdwn",
                          "text": "*Time:* $(date -u +%Y-%m-%d\ %H:%M:%S\ UTC)"
                        }
                      ]
                    },
                    {
                      "type": "section",
                      "text": {
                        "type": "mrkdwn",
                        "text": "${{ github.event.inputs.test_message }}"
                      }
                    }
                  ]
                }
              ]
            }')

          if [ "$response" = "200" ]; then
            echo "‚úÖ Slack test successful (HTTP $response)"
          else
            echo "‚ùå Slack test failed (HTTP $response)"
            exit 1
          fi

  validate-teams:
    runs-on: ubuntu-latest
    if: github.event.inputs.test_type == 'all-channels' || github.event.inputs.test_type == 'teams-only'

    steps:
      - name: Test Teams Integration
        run: |
          echo "Testing Teams integration..."

          response=$(curl -s -o /dev/null -w "%{http_code}" -X POST "${{ secrets.TEAMS_WEBHOOK_URL }}" \
            -H "Content-Type: application/json" \
            -d '{
              "type": "message",
              "attachments": [
                {
                  "contentType": "application/vnd.microsoft.card.adaptive",
                  "content": {
                    "$schema": "http://adaptivecards.io/schemas/adaptive-card.json",
                    "type": "AdaptiveCard",
                    "version": "1.0",
                    "body": [
                      {
                        "type": "TextBlock",
                        "text": "üîß Secret Validation Test",
                        "size": "Large",
                        "weight": "Bolder"
                      },
                      {
                        "type": "FactSet",
                        "facts": [
                          {
                            "title": "Test Type",
                            "value": "Secret Rotation Validation"
                          },
                          {
                            "title": "Status",
                            "value": "Testing Teams Integration"
                          },
                          {
                            "title": "Engineer",
                            "value": "${{ github.actor }}"
                          },
                          {
                            "title": "Time",
                            "value": "$(date -u +%Y-%m-%d\ %H:%M:%S\ UTC)"
                          }
                        ]
                      },
                      {
                        "type": "TextBlock",
                        "text": "${{ github.event.inputs.test_message }}",
                        "wrap": true
                      }
                    ]
                  }
                }
              ]
            }')

          if [ "$response" = "200" ]; then
            echo "‚úÖ Teams test successful (HTTP $response)"
          else
            echo "‚ùå Teams test failed (HTTP $response)"
            exit 1
          fi

  validation-summary:
    runs-on: ubuntu-latest
    needs: [validate-pagerduty, validate-slack, validate-teams]
    if: always()

    steps:
      - name: Generate Validation Report
        run: |
          echo "# üîß Secret Validation Test Results"
          echo ""
          echo "**Test Date:** $(date -u +%Y-%m-%d\ %H:%M:%S\ UTC)"
          echo "**Conducted by:** ${{ github.actor }}"
          echo "**Test Type:** ${{ github.event.inputs.test_type }}"
          echo ""
          echo "## Results"

          # Check PagerDuty result
          if [ "${{ needs.validate-pagerduty.result }}" = "success" ]; then
            echo "- ‚úÖ **PagerDuty:** Integration working correctly"
          elif [ "${{ needs.validate-pagerduty.result }}" = "failure" ]; then
            echo "- ‚ùå **PagerDuty:** Integration failed - check routing key"
          elif [ "${{ needs.validate-pagerduty.result }}" = "skipped" ]; then
            echo "- ‚è≠Ô∏è **PagerDuty:** Skipped (not selected for testing)"
          fi

          # Check Slack result
          if [ "${{ needs.validate-slack.result }}" = "success" ]; then
            echo "- ‚úÖ **Slack:** Integration working correctly"
          elif [ "${{ needs.validate-slack.result }}" = "failure" ]; then
            echo "- ‚ùå **Slack:** Integration failed - check webhook URL"
          elif [ "${{ needs.validate-slack.result }}" = "skipped" ]; then
            echo "- ‚è≠Ô∏è **Slack:** Skipped (not selected for testing)"
          fi

          # Check Teams result
          if [ "${{ needs.validate-teams.result }}" = "success" ]; then
            echo "- ‚úÖ **Teams:** Integration working correctly"
          elif [ "${{ needs.validate-teams.result }}" = "failure" ]; then
            echo "- ‚ùå **Teams:** Integration failed - check webhook URL"
          elif [ "${{ needs.validate-teams.result }}" = "skipped" ]; then
            echo "- ‚è≠Ô∏è **Teams:** Skipped (not selected for testing)"
          fi

          echo ""
          echo "## Next Steps"
          if [[ "${{ needs.validate-pagerduty.result }}" = "failure" || "${{ needs.validate-slack.result }}" = "failure" || "${{ needs.validate-teams.result }}" = "failure" ]]; then
            echo "‚ùå **Action Required:** Some integrations failed. Check the failed channels and verify secret values."
            echo ""
            echo "### Troubleshooting"
            echo "1. Verify secret values in GitHub Settings ‚Üí Secrets and variables ‚Üí Actions"
            echo "2. Check webhook URLs are current and not expired"
            echo "3. Verify PagerDuty integration key belongs to correct service"
            echo "4. Re-run validation after fixing issues"
          else
            echo "‚úÖ **All Good:** Secret rotation validation completed successfully."
            echo ""
            echo "### Recommendations"
            echo "1. Update rotation log with validation results"
            echo "2. Deactivate old secrets in external platforms"
            echo "3. Schedule next rotation (90 days)"
          fi
